---
title: Some light data munging with R, with an application to ranking NFL Teams 
description: >
    John J. Horton
created: !!timestamp '2011-10-08 16:08:00'
tags:
    - Statistics

---


{% mark excerpt -%}
I recently submitted this blog to [R-bloggers](http://www.r-bloggers.com/), which aggregates R-related blog posts. 
It's a fantastic site and has been invaluable to me as I've learned R. 
One of my favorite kinds of articles is the hands-on, "hello world"-style weekend project that 
dips into a topic/technology, so here's my first attempt at one in this style.  

{%- endmark %}

First, some background: I've been working with [Greg](http://glittle.org/) on a project that analyzes the results 
of two-person contests. An important part of the problem is comparing different ranking systems 
that can adjust for the strength of the opponent (e.g., [Elo rating system](http://en.wikipedia.org/wiki/Elo_rating_system), 
[TrueSkill](http://research.microsoft.com/en-us/projects/trueskill/), [Glicko](http://en.wikipedia.org/wiki/Glicko_rating_system), etc.). 
As I understand it, all of these systems are working around the intractability of treating this as a 
purely Bayesian solution and try to deal with things like trends in ability, the distribution of the 
unobserved component, etc.  

---

  

We're still collecting data from a pilot, but in the interim, 
I wanted to start getting my feet wet with some real competition data. 
Sports statistics provide a readily available source of competition data, so my plan was:  
>
  1. Pull some data on NFL games on the 2011 season to date.
  2. Fit a simple model that produces a rank ordering of teams.
  3. Pull data on ESPN's PowerRanking of NFL teams (based on votes by their columnists), using the XML package. 
  4. Make a comparison plot, showing how the two ranks compare, using ggplot2.  

  

For the model, I wanted something really simple (hoping no one from FootballOutsiders is reading this). In my model, 
the difference in scores between the two teams is simply the difference in their "abilities," plus an error term:  


![Error term](http://www.texify.com/img/%5CLARGE%5C%21%5CDelta%20S_%7Bij%7D%20%3D%20%5Calpha%5EH_i%20%20-%20%5Calpha%5EA_j%20%2B%20%5Cepsilon.gif)
  
where the alpha's are team-and-venue (e.g., home or away) specific random effects. 
For our actual rating, we can order teams based on the sum of their estimate home and away effects, i.e.:  

![Image](http://www.texify.com/img/%5CLARGE%5C%21%5Chat%7B%5Calpha%7D_i%5EH%20%2B%20%5Chat%7B%5Calpha%7D_i%5EA.gif)  

Estimating the 32 x 2 parameters---given how little data we actually have---would probably lead to poor results. 
Instead, I used the excellent [lme4](http://cran.r-project.org/web/packages/lme4/index.html) package which approximates a Bayesian estimation where we start with a prior 
that the alpha parameters are normally distributed.  

Putting the last thing first, here's the result of 4), 
comparing my "homebrew" ranking to the ESPN ranking, as of Week 5 (before the October 9th games):

![Image](http://dl.dropbox.com/u/420874/rank_comparisons.png)  

No real comment on my model other than it thinks (a) that ESPN vastly overrates the Chargers and (b) more highly of the Ravens.  

---
  
The code for all the steps is posted below, with explanatory comments:  

    
    library(lme4)
    library(ggplot2)
    library(XML)

    # grab the NFL data & compute the score difference (Home - Away)
    nfl.raw <- read.csv("http://www.repole.com/sun4cast/stats/nfl2011stats.csv")
    nfl.raw$delta <- with(nfl.raw, (ScoreOff - ScoreDef))

    # fit the model
    m <- lmer(delta ~ (1 | TeamName) + (1|Opponent), data = nfl.raw)

    # extract the model estimates & put into a data frame
    df <- data.frame(team = rownames(ranef(m)$Opponent),
                     score = ranef(m)$TeamName - ranef(m)$Opponent)
    colnames(df) <- c("team", "score")
    rownames(df) <- 1:(dim(df)[1])

    # reorder the dataframe by score & add a "rank" variable
    df$team <- with(df, reorder(team, -score, mean))
    df <- df[with(df, order(-score)),]
    df$rank <- 1:32

    # need to extract the team name w/o the city, to be able to match up
    # with the ESPN format
    get.short.name <- function(ln)
      tail(strsplit(as.character(ln), " ")[[1]],1)

    df$short_name <- sapply(df$team, get.short.name)

    # grab the data from ESPN, using modified code from: http://goo.gl/mElLS
    theurl <- "http://espn.go.com/nfl/powerrankings"
    tables <- readHTMLTable(theurl)
    espn.ranks <- tables[[1]][3:34,3]

    # teams are listed in rank order, so position in the table is their rank
    df$espn_rank <- sapply(df$short_name, function(x) which(x==espn.ranks))
    
    # plot comparing the two ranking systems
    g <- ggplot(df) +
      geom_text(aes(x="Homebrew Rank", y = 32-rank, label=short_name), size=8, hjust=1) +
      geom_text(aes(x="ESPN Ranking", y = 32-espn_rank, label=short_name), size=8, hjust=0) +
      geom_segment(aes(x="Homebrew Rank", y=32-rank, xend="ESPN Ranking", yend=32-espn_rank,
                       colour=I(rank - espn_rank)), alpha=.5) + theme_bw() +
      opts(axis.ticks=theme_blank()) + xlab("") + ylab("") +
      scale_y_continuous(breaks=c(-1,32), labels=c("",""))