<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <style>
  
  body{
      margin: 0 auto;
      font-family: Georgia, Palatino, serif;
      color: #444444;
      line-height: 1;
      max-width: 960px;
      padding: 30px;
  }
  h1, h2, h3, h4 {
      color: #111111;
      font-weight: 400;
  }
  h1, h2, h3, h4, h5, p {
      margin-bottom: 24px;
      padding: 0;
      max-width: 480px; 
  }
  h1 {
      font-size: 48px;
  }
  h2 {
      font-size: 36px;
      /* The bottom margin is small. It's designed to be used with gray meta text
       * below a post title. */
      margin: 24px 0 6px;
  }
  h3 {
      font-size: 24px;
  }
  h4 {
      font-size: 21px;
  }
  h5 {
      font-size: 18px;
  }
  a {
      color: #0099ff;
      margin: 0;
      padding: 0;
      vertical-align: baseline;
  }
  a:hover {
      text-decoration: none;
      color: #ff6600;
  }
  a:visited {
      color: purple;
  }
  ul, ol {
      padding: 0;
      margin: 0;
  }
  li {
      line-height: 24px;
  }
  li ul, li ul {
      margin-left: 24px;
  }
  p, ul, ol {
      font-size: 16px;
      line-height: 24px;
      max-width: 540px;
  }
  
  
  pre {
     margin-top: 0;
     max-width: 95%;
     border: 1px solid #ccc;
     white-space: pre-wrap;
  }
  
  pre code {
     display: block; padding: 0.5em;
  }
  
  code.r, code.cpp {
     background-color: #F8F8F8;
  }
  
  table, td, th {
    border: none;
  }
  
  blockquote {
     color:#666666;
     margin:0;
     padding-left: 1em;
     border-left: 0.5em #EEE solid;
  }
  
  
  
  /* pre { */
  /*     padding: 0px 24px; */
  /*     max-width: 800px; */
  /*     white-space: pre-wrap; */
  /* } */
  /* code { */
  /*     font-family: Consolas, Monaco, Andale Mono, monospace; */
  /*     line-height: 1.5; */
  /*     font-size: 13px; */
  /* } */
  /* aside { */
  /*     display: block; */
  /*     float: right; */
  /*     width: 390px; */
  /* } */
  /* blockquote { */
  /*     border-left:.5em solid #eee; */
  /*     padding: 0 2em; */
  /*     margin-left:0; */
  /*     max-width: 476px; */
  /* } */
  /* blockquote  cite { */
  /*     font-size:14px; */
  /*     line-height:20px; */
  /*     color:#bfbfbf; */
  /* } */
  /* blockquote cite:before { */
  /*     content: '\2014 \00A0'; */
  /* } */
  
  /* blockquote p {   */
  /*     color: #666; */
  /*     max-width: 460px; */
  /* } */
  hr {
      width: 540px;
      text-align: left;
      margin: 0 auto 0 0;
      color: #999;
  }
  
  /* Code below this line is copyright Twitter Inc. */
  
  button,
  input,
  select,
  textarea {
    font-size: 100%;
    margin: 0;
    vertical-align: baseline;
    *vertical-align: middle;
  }
  button, input {
    line-height: normal;
    *overflow: visible;
  }
  button::-moz-focus-inner, input::-moz-focus-inner {
    border: 0;
    padding: 0;
  }
  button,
  input[type="button"],
  input[type="reset"],
  input[type="submit"] {
    cursor: pointer;
    -webkit-appearance: button;
  }
  input[type=checkbox], input[type=radio] {
    cursor: pointer;
  }
  /* override default chrome & firefox settings */
  input:not([type="image"]), textarea {
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
  }
  
  input[type="search"] {
    -webkit-appearance: textfield;
    -webkit-box-sizing: content-box;
    -moz-box-sizing: content-box;
    box-sizing: content-box;
  }
  input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
  }
  label,
  input,
  select,
  textarea {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 13px;
    font-weight: normal;
    line-height: normal;
    margin-bottom: 18px;
  }
  input[type=checkbox], input[type=radio] {
    cursor: pointer;
    margin-bottom: 0;
  }
  input[type=text],
  input[type=password],
  textarea,
  select {
    display: inline-block;
    width: 210px;
    padding: 4px;
    font-size: 13px;
    font-weight: normal;
    line-height: 18px;
    height: 18px;
    color: #808080;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
  }
  select, input[type=file] {
    height: 27px;
    line-height: 27px;
  }
  textarea {
    height: auto;
  }
  
  /* grey out placeholders */
  :-moz-placeholder {
    color: #bfbfbf;
  }
  ::-webkit-input-placeholder {
    color: #bfbfbf;
  }
  
  input[type=text],
  input[type=password],
  select,
  textarea {
    -webkit-transition: border linear 0.2s, box-shadow linear 0.2s;
    -moz-transition: border linear 0.2s, box-shadow linear 0.2s;
    transition: border linear 0.2s, box-shadow linear 0.2s;
    -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    -moz-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  input[type=text]:focus, input[type=password]:focus, textarea:focus {
    outline: none;
    border-color: rgba(82, 168, 236, 0.8);
    -webkit-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);
    -moz-box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 8px rgba(82, 168, 236, 0.6);
  }
  
  /* buttons */
  button {
    display: inline-block;
    padding: 4px 14px;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    font-size: 13px;
    line-height: 18px;
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    border-radius: 4px;
    -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
    background-color: #0064cd;
    background-repeat: repeat-x;
    background-image: -khtml-gradient(linear, left top, left bottom, from(#049cdb), to(#0064cd));
    background-image: -moz-linear-gradient(top, #049cdb, #0064cd);
    background-image: -ms-linear-gradient(top, #049cdb, #0064cd);
    background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #049cdb), color-stop(100%, #0064cd));
    background-image: -webkit-linear-gradient(top, #049cdb, #0064cd);
    background-image: -o-linear-gradient(top, #049cdb, #0064cd);
    background-image: linear-gradient(top, #049cdb, #0064cd);
    color: #fff;
    text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.25);
    border: 1px solid #004b9a;
    border-bottom-color: #003f81;
    -webkit-transition: 0.1s linear all;
    -moz-transition: 0.1s linear all;
    transition: 0.1s linear all;
    border-color: #0064cd #0064cd #003f81;
    border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
  }
  button:hover {
    color: #fff;
    background-position: 0 -15px;
    text-decoration: none;
  }
  button:active {
    -webkit-box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    -moz-box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
    box-shadow: inset 0 3px 7px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  button::-moz-focus-inner {
    padding: 0;
    border: 0;
  }
  </style>
</head>
<body>
<h1 id="power-calculations-without-p-values-or-greek-letters">&quot;Power Calculations&quot; without P-values or Greek letters</h1>
<p>In my experience, the most common statistical question witin a company---bar none---is &quot;How long should I run my experiment for?&quot; In other words, they want a <a href="http://en.wikipedia.org/wiki/Statistical_power">power calculation</a>.<br />Although the standard approach to doing power calculations is well-understood, I haven't found it to be very effective as a business process within a data-driven company. The problem is that the key concepts for a conventional power calculation are difficult to grasp. Even very smart people---researcher, science journalists etc.---have trouble understanding the proper interpretion of <a href="http://andrewgelman.com/2013/03/12/misunderstanding-the-p-value/">p-values</a>. Type I and Type II errors might be the least descriptively-named concepts in history. Even the name &quot;power calculation&quot; suggests something obscure but at the same time something rote that does not require much thinking beyond pluggin the right things into a fomula. This is unfortunate, because a well done power analysis can be like a dry rehearsal for the experiment, exposing problems in plan beyond just a too-small proposed sample size.</p>
<p>So what's my solution? It's pretty simple---I just simulate data from the experiment many times and then plot the empirical distribution of the effect size, using the same code that will use to analyze the experiment. This isn't at all complicated. Modern computers are so fast that I can, interactively, work with the person desiging an experiment and how them how different assumptions about effects sizes and choices of sample size affect likely outcomes. Doing this can help users of experiments get a more more intuitive sense of the relationship between sample size and sampling variance in the quantity they estimate.</p>
<p>Below, I describe my basic strategy for helping someone conduct a power calculation. At the end, I work through a full example.</p>
<h2 id="pick-an-outcome-and-simulate-its-distribution">1. Pick an outcome and simulate its distribution</h2>
<p>Picking a good outcome metrics is critical for the experiment. Sometimes the right metric is obvious, but other times, ther are several viable candidates, each with pluses and minuses. A commong tradeoff is between importance and speed of measurement. For example, you can measure clicks almost instantly; something like &quot;how did a project turn out (as measured by feedback)&quot; could take months or years. Only a person immersed in the business---usually the one needing the power calculation---can decide which metrics make sense to use (once they know the power trade-offs). When presented with the question of what metrics to look at, would-be experimenters often want to split the baby and just look at a whole bunch of outcomes. However, people can be easily convinved of why this isn't a good idea (a link to this <a href="http://xkcd.com/882/">cartoon</a> can help).</p>
<p>A classic power calculation makes use of the fact that the sampling distribution of the average treatment effect will be approximately normally distributed. The central limit theorem means that the you don't <em>need</em> to know the distribution the metric is calculated from. However, doing the power calculation via simulation has several advantaes. First, at least to me, I think it's harder to mess up than the alternative---writing probability statements, transforming variables, using the right critical values etc. Second, simulating the data also lets you to explore more complex treatment effect scenarios beyond just shifts in a mean. For example, it's not uncommon for a product manager to hypothesize that a feature might &quot;only work for big clients&quot;---doing a standard power calculation in such a setting would be a challenge, but with simulation, it's easy. Finally, being forced to simulate the data forces you to understand the data generating process beyond just finding the mean and standard deviation.</p>
<h2 id="simulate-the-analysis-of-the-experiment-under-different-assumptions">2. Simulate the analysis of the experiment under different assumptions</h2>
<p>The would-be experimenter probably cannot tell you &quot;I want to be able to detect a 5% increase with 80% probability at the 0.05 significance level.&quot; If they could, they'd probably do their own power calculation. However, when you show them what will happen with a particular metric and particular sample size, they can often talk about the results in terms of the business case---i.e., how much confidence they need in the magnitude and direction of some effect.</p>
<blockquote>
<p><em>Me</em>: Let's imagine this feature decreases converstions by 5%. If we ran the experiment a whole bunch of times, this is the distribution of effect estimates we'd get (<em>run simulation and make plot</em>)</p>
</blockquote>
<blockquote>
<p><em>Them:</em> Woah - there's a 40% chance we'd find a <em>positive</em> effect? That's no good. We'd walk right into that.</p>
</blockquote>
<blockquote>
<p><em>Me:</em> Ok, let's increase the sample by 50% (<em>re-run simulation with new sample size</em>)</p>
</blockquote>
<blockquote>
<p><em>Them:</em> Ah - that's much better. I can see that if it's that bad, we'll almost certainly see a negative effect.</p>
</blockquote>
<p>Notice the words &quot;p-value&quot; or &quot;Type I or Type II&quot; error never needed to be said. We can talk strictly about effect sizes and magnitudes and probabilities.</p>
<h2 id="an-example-with-r-code">An example with R code</h2>
<p>To make this more concreate, let's suppose we have to make some changes to the business (the status quo isn't possible), but we have two options to test. For simplicity, we'll just call one option the control and the other cell the treatment. Let's suppose that the metric is how much a client spends. Suppose we are indifferent, from a cost stand-point between the two methods, so at the end of the experiment, we're just going to pick the one that does better. In this horse-race scenario, we don't care about statistical significance at all---we're going to pick the cell with the best point estimate. However, we'd like to have some sense of our chance of picking the losing horse. The point of our analysis is to see how often we pick the wrong hose for a given sample size, under an assumption about how bad the bad hourse actually is.</p>
<p>Suppose we know that historically, spend is log normally distributed, with parameters:</p>
<pre class="sourceCode r"><code class="sourceCode r">mu &lt;-<span class="st"> </span><span class="fl">3.8</span>
sigma &lt;-<span class="st"> </span><span class="fl">1.8</span></code></pre>
<p>And suppose we think the experimental feature will raise spend by 5%.</p>
<pre class="sourceCode r"><code class="sourceCode r">effect &lt;-<span class="st"> </span><span class="fl">0.05</span></code></pre>
<p>We can simulate the data assuming 500 subjects in each experimental cell:</p>
<pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="dv">500</span>
<span class="kw">set.seed</span>(<span class="dv">6152011</span>)
spend.control &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">rnorm</span>(n, mu, sigma))
spend.treatment &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">rnorm</span>(n, mu +<span class="st"> </span>effect, sigma))
df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">spend =</span> <span class="kw">c</span>(spend.control, spend.treatment), <span class="dt">cell =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;ctrl&quot;</span>, 
    n), <span class="kw">rep</span>(<span class="st">&quot;trt&quot;</span>, n)))</code></pre>
<p>and can then plot the distribution:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">qplot</span>(<span class="kw">log</span>(spend), <span class="dt">colour =</span> <span class="kw">factor</span>(cell), <span class="dt">geom =</span> <span class="st">&quot;density&quot;</span>, <span class="dt">data =</span> df)</code></pre>
<div class="figure">
<img src="figure/unnamed-chunk-4.png" alt="plot of chunk unnamed-chunk-4" /><p class="caption">plot of chunk unnamed-chunk-4</p>
</div>
<p>As expected, the empirical distribution of the treatment values is left-shifted vis-a-vis the control. We can also perform the regression we would actually perform in practice:</p>
<pre class="sourceCode r"><code class="sourceCode r">m &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">log</span>(spend) ~<span class="st"> </span>cell, <span class="dt">data =</span> df)
<span class="kw">summary</span>(m)</code></pre>
<pre><code>## 
## Call:
## lm(formula = log(spend) ~ cell, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -6.06  -1.21  -0.05   1.21   5.58 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   3.8813     0.0808   48.01   &lt;2e-16 ***
## celltrt      -0.2001     0.1143   -1.75     0.08 .  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 
## 
## Residual standard error: 1.81 on 998 degrees of freedom
## Multiple R-squared: 0.00306, Adjusted R-squared: 0.00206 
## F-statistic: 3.06 on 1 and 998 DF,  p-value: 0.0804</code></pre>
<p>We can see that with this particular choice of random seed, the point estimate of the treatment is more than 20%---a pretty substantial over-statement, though 5% (the true value) is within the 95% prediction interval. Let's now simulate running this experiment multiple times.</p>
<pre class="sourceCode r"><code class="sourceCode r">get.tau &lt;-<span class="st"> </span>function(effect, sample.size) {
    spend.control &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">rnorm</span>(sample.size, mu, sigma))
    spend.treatment &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">rnorm</span>(sample.size, mu +<span class="st"> </span>effect, sigma))
    df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">spend =</span> <span class="kw">c</span>(spend.control, spend.treatment), <span class="dt">cell =</span> <span class="kw">c</span>(<span class="kw">rep</span>(<span class="st">&quot;ctrl&quot;</span>, 
        sample.size), <span class="kw">rep</span>(<span class="st">&quot;trt&quot;</span>, sample.size)))
    m &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">log</span>(spend) ~<span class="st"> </span>cell, <span class="dt">data =</span> df)
    <span class="kw">coef</span>(m)[<span class="dv">2</span>]
}
tau.hats &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw">get.tau</span>(-<span class="fl">0.05</span>, <span class="dv">1000</span>))
<span class="kw">qplot</span>(tau.hats, <span class="dt">binwidth =</span> <span class="fl">0.4</span>/<span class="dv">30</span>) +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/unnamed-chunk-6.png" alt="plot of chunk unnamed-chunk-6" /><p class="caption">plot of chunk unnamed-chunk-6</p>
</div>
<p>We can see that with this sample size, it looks like about a 1/3 of the time, with this sample size we'll report a positive treatment effect, despite the truth being a 5% reduction. Confirming what we can see graphically:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(tau.hats &gt;<span class="st"> </span><span class="dv">0</span>)</code></pre>
<pre><code>## [1] 0.26</code></pre>
<p>This probably isn't good enough. Let's try tripling the sample size:</p>
<pre class="sourceCode r"><code class="sourceCode r">tau.hats2 &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw">get.tau</span>(-<span class="fl">0.05</span>, <span class="dv">3000</span>))
<span class="kw">qplot</span>(tau.hats2, <span class="dt">binwidth =</span> <span class="fl">0.4</span>/<span class="dv">30</span>) +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/unnamed-chunk-8.png" alt="plot of chunk unnamed-chunk-8" /><p class="caption">plot of chunk unnamed-chunk-8</p>
</div>
<p>Eyeballing, it looks like 10% of the mass is to the right of 0.0.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(tau.hats2 &gt;<span class="st"> </span><span class="dv">0</span>)</code></pre>
<pre><code>## [1] 0.118</code></pre>
<p>Maybe we can live with this sample size of 3,000. But let's assume the effect is worse---that it's actually a 15% fall off in the treatment. What does that look like?</p>
<pre class="sourceCode r"><code class="sourceCode r">tau.hats2 &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">500</span>, <span class="kw">get.tau</span>(-<span class="fl">0.15</span>, <span class="dv">3000</span>))
<span class="kw">qplot</span>(tau.hats2, <span class="dt">binwidth =</span> <span class="fl">0.4</span>/<span class="dv">30</span>) +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>), <span class="dt">colour =</span> <span class="st">&quot;red&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/unnamed-chunk-10.png" alt="plot of chunk unnamed-chunk-10" /><p class="caption">plot of chunk unnamed-chunk-10</p>
</div>
<p>OK! If bad horse is really bad, we've got almost no chance of picking the bad horse. Obviously this kind of analysis needs to be tailored to the situation at hand, but the nice thing about this simulation is that makes changes is usually quite simple.</p>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'johnjosephhorton'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
</body>
</html>
