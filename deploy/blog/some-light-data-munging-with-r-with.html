<!doctype html>
<!-- https://github.com/paulirish/html5-boilerplate/blob/master/index.html -->
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="">

  <!-- encoding must be specified within the first 512 bytes
        www.whatwg.org/specs/web-apps/current-work/multipage/semantics.html#charset -->

  <!-- meta element for compatibility mode needs to be before
        all elements except title & meta
        msdn.microsoft.com/en-us/library/cc288325(VS.85).aspx -->
  <!-- Chrome Frame is only invoked if meta element for
        compatibility mode is within the first 1K bytes
        code.google.com/p/chromium/issues/detail?id=23003 -->

  <title>Some light data munging with R, with an application to ranking NFL Teams</title>
  <meta name="description" content="John J. Horton
">
  <meta name="author" content="Lakshmi Vyasarajan">

  <!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="">

    <!-- Place favicon.ico & apple-touch-icon.png
        in the root of your domain and delete these references -->
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
    <link rel="stylesheet" href="/media/css/site.css">
  <link rel="stylesheet" href="/media/css/syntax.css">
  <link rel="stylesheet" href="/media/css/bootstrap.min.css">
  <link rel="stylesheet" href="/media/css/extra.css">
  
    <!-- All JavaScript at the bottom, except for Modernizr which
        enables HTML5 elements & feature detects -->
    <script src="/media/js/libs/modernizr-1.7.min.js"></script>
    <script src="/media/js/bootstrap.min.js"></script>
    </head>
<body id="some-light-data-munging-with-r-with">
    <div id="container">
            <div id="main" role="main">
          <header class="banner clearfix">
          <h1>John J. Horton </h1>
            <h3>

</h3>                              <nav class=main_nav>
<div class='navbar'>
<div class='navbar-inner'>
<div class='container'>
    <ul class='nav nav-pills'>
                <li class=" about">
            <a title="About"
                class=" about"
                href="/index.html">
                About
            </a>
        </li>        <li class=" active blog">
            <a title="Blog"
                class=" active blog"
                href="/blog">
                Online Labor Blog
            </a>
        </li>        <li class=" papers">
            <a title="Papers"
                class=" papers"
                href="/papers">
                Papers
            </a>
        </li>        <li class=" portfolio">
            <a title="Portfolio"
                class=" portfolio"
                href="/portfolio">
                CV
            </a>
        </li>    </ul>
</div>
</div>
</div>
</nav>
                    </header>
	  <hr>
          <section class="content">
          <div class='float_right'>
<a href="https://twitter.com/johnjhorton" class="twitter-follow-button" data-show-count="false">Follow @johnjhorton</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</div>
<article class="post">
<nav class="post_nav">
<a class="backlink" href="/blog">Back to list</a>
<a class="prev"
    title="Workers-as-Bundled-Goods"
        href="/blog/workers_as_bundled_goods.html">
    Previous
</a>

<a class="next"
    title="All public government data should be easily machine readable"
        href="/blog/all-public-government-data-should-be.html">
    Next
</a>

<br>
<div id="twitter_share">
<a href="http://twitter.com/share"
    class="twitter-share-button"
    data-count="vertical"
    data-via="ringce">Tweet</a>
    <script type="text/javascript"
        src="http://platform.twitter.com/widgets.js"></script>
</div>
<div id="facebook_like">
<iframe src="http://www.facebook.com/plugins/like.php?href&amp;layout=box_count&amp;show_faces=false&amp;width=450&amp;action=like&amp;font=arial&amp;colorscheme=light&amp;height=65"
            scrolling="no"
            frameborder="0"
            style="border:none; overflow:hidden; width:450px; height:65px;"
            allowTransparency="true"></iframe>
</div>
</nav>
<h1 class="title">
    <a href="/blog/some-light-data-munging-with-r-with.html">
        Some light data munging with R, with an application to ranking NFL Teams
    </a>
</h1>
<time datetime="2011-10-08">
    Posted: Sat, 08 Oct 2011
</time>

<ul class="tags clear">
<li>
    <a class="small" href="/blog/tags/Statistics.html">
        Statistics
    </a>
</li>
</ul>
<p>I recently submitted this blog to <a href="http://www.r-bloggers.com/">R-bloggers</a>, which aggregates R-related blog posts. 
It&#8217;s a fantastic site and has been invaluable to me as I&#8217;ve learned R. 
One of my favorite kinds of articles is the hands-on, &#8220;hello world&#8221;-style weekend project that 
dips into a topic/technology, so here&#8217;s my first attempt at one in this style.
First, some background: I&#8217;ve been working with <a href="http://glittle.org/">Greg</a> on a project that analyzes the results 
of two-person contests. An important part of the problem is comparing different ranking systems 
that can adjust for the strength of the opponent (e.g., <a href="http://en.wikipedia.org/wiki/Elo_rating_system">Elo rating system</a>, 
<a href="http://research.microsoft.com/en-us/projects/trueskill/">TrueSkill</a>, <a href="http://en.wikipedia.org/wiki/Glicko_rating_system">Glicko</a>, etc.). 
As I understand it, all of these systems are working around the intractability of treating this as a 
purely Bayesian solution and try to deal with things like trends in ability, the distribution of the 
unobserved component, etc.<br />
</p>
<hr />
<p>We&#8217;re still collecting data from a pilot, but in the interim, 
I wanted to start getting my feet wet with some real competition data. 
Sports statistics provide a readily available source of competition data, so my plan was:<br />
</p>
<blockquote>
<ol>
<li>Pull some data on <span class="caps">NFL</span> games on the 2011 season to&nbsp;date.</li>
<li>Fit a simple model that produces a rank ordering of&nbsp;teams.</li>
<li>Pull data on <span class="caps">ESPN</span>&#8217;s PowerRanking of <span class="caps">NFL</span> teams (based on votes by their columnists), using the <span class="caps">XML</span>&nbsp;package. </li>
<li>Make a comparison plot, showing how the two ranks compare, using ggplot2.<br />
</li>
</ol>
</blockquote>
<p>For the model, I wanted something really simple (hoping no one from FootballOutsiders is reading this). In my model, 
the difference in scores between the two teams is simply the difference in their &#8220;abilities,&#8221; plus an error term:<br />
</p>
<p><img alt="Error term" src="http://www.texify.com/img/%5CLARGE%5C%21%5CDelta%20S_%7Bij%7D%20%3D%20%5Calpha%5EH_i%20%20-%20%5Calpha%5EA_j%20%2B%20%5Cepsilon.gif" /></p>
<p>where the alpha&#8217;s are team-and-venue (e.g., home or away) specific random effects. 
For our actual rating, we can order teams based on the sum of their estimate home and away effects, i.e.:<br />
</p>
<p><img alt="Image" src="http://www.texify.com/img/%5CLARGE%5C%21%5Chat%7B%5Calpha%7D_i%5EH%20%2B%20%5Chat%7B%5Calpha%7D_i%5EA.gif" /><br />
</p>
<p>Estimating the 32 x 2 parameters&#8211;given how little data we actually have&#8211;would probably lead to poor results. 
Instead, I used the excellent <a href="http://cran.r-project.org/web/packages/lme4/index.html">lme4</a> package which approximates a Bayesian estimation where we start with a prior 
that the alpha parameters are normally distributed.<br />
</p>
<p>Putting the last thing first, here&#8217;s the result of 4), 
comparing my &#8220;homebrew&#8221; ranking to the <span class="caps">ESPN</span> ranking, as of Week 5 (before the October 9th&nbsp;games):</p>
<p><img alt="Image" src="http://dl.dropbox.com/u/420874/rank_comparisons.png" /><br />
</p>
<p>No real comment on my model other than it thinks (a) that <span class="caps">ESPN</span> vastly overrates the Chargers and (b) more highly of the Ravens.<br />
</p>
<hr />
<p>The code for all the steps is posted below, with explanatory comments:<br />
</p>
<pre><code>library(lme4)
library(ggplot2)
library(XML)

# grab the NFL data <span class="amp">&amp;</span> compute the score difference (Home - Away)
nfl.raw &lt;- read.csv("http://www.repole.com/sun4cast/stats/nfl2011stats.csv")
nfl.raw$delta &lt;- with(nfl.raw, (ScoreOff - ScoreDef))

# fit the model
m &lt;- lmer(delta ~ (1 | TeamName) + (1|Opponent), data = nfl.raw)

# extract the model estimates <span class="amp">&amp;</span> put into a data frame
df &lt;- data.frame(team = rownames(ranef(m)$Opponent),
                 score = ranef(m)$TeamName - ranef(m)$Opponent)
colnames(df) &lt;- c("team", "score")
rownames(df) &lt;- 1:(dim(df)[1])

# reorder the dataframe by score <span class="amp">&amp;</span> add a "rank" variable
df$team &lt;- with(df, reorder(team, -score, mean))
df &lt;- df[with(df, order(-score)),]
df$rank &lt;- 1:32

# need to extract the team name w/o the city, to be able to match up
# with the <span class="caps">ESPN</span> format
get.short.name &lt;- function(ln)
  tail(strsplit(as.character(ln), " ")/1,1)

df$short_name &lt;- sapply(df$team, get.short.name)

# grab the data from <span class="caps">ESPN</span>, using modified code from: http://goo.gl/mElLS
theurl &lt;- "http://espn.go.com/nfl/powerrankings"
tables &lt;- readHTMLTable(theurl)
espn.ranks &lt;- tables/1[3:34,3]

# teams are listed in rank order, so position in the table is their rank
df$espn_rank &lt;- sapply(df$short_name, function(x) which(x==espn.ranks))

# plot comparing the two ranking systems
g &lt;- ggplot(df) +
  geom_text(aes(x="Homebrew Rank", y = 32-rank, label=short_name), size=8, hjust=1) +
  geom_text(aes(x="<span class="caps">ESPN</span> Ranking", y = 32-espn_rank, label=short_name), size=8, hjust=0) +
  geom_segment(aes(x="Homebrew Rank", y=32-rank, xend="<span class="caps">ESPN</span> Ranking", yend=32-espn_rank,
                   colour=I(rank - espn_rank)), alpha=.5) + theme_bw() +
  opts(axis.ticks=theme_blank()) + xlab("") + ylab("") +
  scale_y_continuous(breaks=c(-1,32), labels=c("",""))
</code></pre></article>
 <center><a href="/blog/atom.xml"><< Subscribe via RSS Feed >></a></center>          </section>
      </div>
      </div> <!--! end of #container -->
  <footer>
    
  </footer>
      <!-- Javascript at the bottom for fast page loading -->
    <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.5.1.min.js">\x3C/script>')</script>
  
    

  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script>DD_belatedPNG.fix('img, .png_bg'); // Fix any <img> or .png_bg bg-images. Also, please read goo.gl/mZiyb </script>
  <![endif]-->

      
  </body>
</html>